<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="./ts-header.html">

<dom-module id="ts-app">
  <template>
    <style>
      :host {
        display: block;
        min-height: 500px;
        padding-top: 60px;
      }
    </style>
    <ts-header logged-in-user={{userFacebookData}}></ts-header>
    <template is="dom-if" if="{{!loggedIn}}">
      <button on-tap="fbLogin">Log In with FB</button>
    </template>

    <template is="dom-if" if="{{loggedIn}}">
      <p> Already logged in </p>
      <button on-tap="fbLogout">Logout</button>
    </template>
  </template>

  <script>
    Polymer({
      is: 'ts-app',

      properties: {
        /**
        * Stores whether user is authenticated through Facebook.
        */
        loggedIn: {
          type: Boolean,
          value: false,
        },
        /**
        * Facebook's user id for authenticated user.
        */
        userFacebookId: {
          type: String,
          value: ""
        },
        /**
        * Facebook's user data for authenticated user.
        */
        userFacebookData: {
          type: Object,
          value: function () {
            return {}
          }
        },
        /**
        * Stores Facebook's access token.
        */
        facebookAccessToken: {
          type: String,
          value: ""
        },
        /**
        * Stores the server's access token.
        */
        serverAccessToken: {
          type: String,
          value: ""
        }
      },
      /**
      * On view attached to DOM, checking login status.
      */
      attached: function () {
        this.getFBLoginStatus(function callback(response) {
          this.handleGetLoginStatus(response)
        }.bind(this))
      },
      /**
      * Makes sure global window.FB variable has been defined before getting the login status.
      * @param {function} callback - called when getLoginStatus returns a response
      */
      getFBLoginStatus: function (callback) {
        if (!window.FB) {
          setTimeout(function() {this.getFBLoginStatus(callback)}.bind(this), 200)
        } else {
          window.FB.getLoginStatus(function(response) {
            console.log(response)
            callback(response)
          }.bind(this));
        }
      },
      /**
      * On Facebook's login button press, checking login status.
      */
      fbLogin: function () {
        this.getFBLoginStatus(function callback(response) {
          this.handleGetLoginStatus(response, true)
        }.bind(this))
      },
      /**
      * On Facebook's logout button press, initiating logout process.
      */
      fbLogout: function () {
        window.FB.logout();
      },
      /**
      * Handles Facebook's Authentication response
      * @param {object} response - Facebook's authentication response.
      * @param {boolean} forceLogin - If set to true, runs Facebook's login process.
      */
      handleGetLoginStatus: function (response, forceLogin) {
        if (response.status === 'connected') {
            this.set("loggedIn", true)
            this.set("facebookAccessToken", response.authResponse.accessToken)
            this.set("userFacebookId", response.authResponse.userID)
            this.getServerAccessToken()
            this.getFBUserInfo(this.userFacebookId)
          } else if (forceLogin){
            window.FB.login(function(response){
              this.handleGetLoginStatus(response)
            }.bind(this))
          }
      },
      /**
      * Uses Facebook's Graph API to query name and picture by user id.
      * @param {string} userId - User's Facebook id
      * @param {object} params - Optional parameters to override default ones
      */
      getFBUserInfo: function (userId, params) {
        if (!this.facebookAccessToken) {
          console.log("User must be authenticated before using Facebook's Graph API")
          return
        }
        if (!userId || (!typeof userId === "string")) {
          console.log("Please provide a valid user id.")
          return
        }
        let defaultParams = {
          fields: "name, picture.width(500).height(500)"
        }
        params = params || defaultParams
        params.access_token = this.facebookAccessToken
        FB.api(userId, params, function(response) {
          this.set("userFacebookData", response)
        }.bind(this));
      },
      /**
      * Sends Facebook's access token to the server to get the server's access token.
      */
      getServerAccessToken: function () {
        var xhr = new XMLHttpRequest();

        xhr.open('GET', '/auth/facebook/token/login', true);
        xhr.setRequestHeader('access_token', this.facebookAccessToken)
        xhr.onload = function () {
          let responseUrl = xhr.responseURL

          // verifying responseUrl is valid
          if (responseUrl && responseUrl.indexOf("?") > 0 && responseUrl.indexOf("=" > 0) && responseUrl.indexOf("access_token" > 0)) {
            let queryParams = responseUrl.split("?")[1].split("=")
            let accessTokenIndex = queryParams.indexOf("access_token")
            let accessToken = queryParams[accessTokenIndex + 1]
            
            this.set("serverAccessToken", accessToken)
          } else {
            console.error("Invalid responeUrl returned: " + responseUrl)
          }
        }.bind(this)
        xhr.send(null);
      }
    });
  </script>
</dom-module>
